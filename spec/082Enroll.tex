\section{Процесс \texttt{Enroll}}\label{PROCESSES.Enroll}

\subsection{Процедуры}\label{PROCESSES.Enroll.List}

В процессе участвуют:  
сторона, запрашивающая сертификат (будущий его субъект),
УЦ и РЦ или оператор РЦ. 

Процесс состоит из следующих процедур:
\begin{itemize}
\item[--]
генерация ключей;
\item[--]
подготовка запроса на получение сертификата;
\item[--]
аутентификация субъекта;
\item[--]
заверение запроса;
\item[--]
отправка запроса УЦ;
\item[--]
обработка запроса;
\item[--]
возврат ответа;
\item[--]
обработка ответа.
\end{itemize}

Процесс может конфигурироваться: 
одни и те же процедуры могут выполняться разными сторонами,
процедуры могут опускаться, может меняться последовательность 
процедур. При конфигурировании могут быть реализованы следующие сценарии.

\texttt{Enroll1}. 
Субъект самостоятельно генерирует ключи и готовит запрос.
Оператор РЦ проводит аутентификацию, заверяет и отправляет запрос, 
обрабатывает ответ. Результат передается субъекту.

\texttt{Enroll2}. 
Субъект взаимодействует с РЦ с помощью аппаратного КТ. РЦ в качестве 
терминала проводит аутентификацию КТ, вызывает команду генерации ключей,
извлекает идентификационные данные и открытый ключ, готовит запрос, 
заверяет и отправляет его УЦ. РЦ обрабатывает ответ УЦ и записывает 
результат обработки на КТ. Ключи генерируются внутри КТ субъекта,
хотя генерацию инициирует РЦ.

\texttt{Enroll3}. 
РЦ персонализирует аппаратный КТ субъекта. 
Аутентификация не проводится. РЦ самостоятельно генерирует ключи,
готовит запрос, заверяет и отправляет его, записывает сертификат из ответа 
в КТ.

\texttt{Enroll4}.
Субъект предварительно проходит аутентификацию, регистрирует свои 
идентификационные данные и получает пароль~\texttt{enrollPwd}, 
который указывает в своем запросе. Субъект самостоятельно готовит и 
отправляет запрос, обрабатывает ответ.

Первый сценарий является стандартным способом выпуска первого сертификата. 
Его недостаток~--- невозможность реализации онлайн, 
без визита в подразделение РЦ. Избежать визита можно с помощью второго 
сценария, но при этом необходимо располагать КТ. 
%
Третий сценарий должен использоваться при массовом выпуске КТ.
%
Четвертый сценарий предназначен для выпуска сертификатов~КА.

\subsection{Генерация ключей}\label{PROCESSES.Enroll.Gen}

Генерируются личный и открытый ключи СТБ~34.101.45.
Для генерации должен использоваться алгоритм~\texttt{bign-genkeypair}
этого стандарта. В алгоритме должны использоваться 
стандартные параметры эллиптической кривой (см. п.~\ref{CRYPTO.Params}).

В~\texttt{Enroll1}, \texttt{Enroll4} ключи генерирует сам субъект 
(владелец ключей) с помощью программного или аппаратного КТ. 
Сгенерированный личный ключ сохраняется либо в ключевом контейнере, либо 
внутри аппаратного КТ. Открытый ключ может не сохраняться, при необходимости он 
вычисляется по личному ключу.

% \doubt{правильно ли переносится на ка?}

В~\texttt{Enroll2} ключи генерируются внутри аппаратного КТ субъекта,
но запрос на генерацию дает РЦ, взаимодействующий с КТ в терминальном 
режиме. 

В~\texttt{Enroll3} ключи генерирует РЦ. 
РЦ может использовать сгенерированный личный ключ только для 
подписи запроса на получение сертификата. РЦ должен уничтожить личный ключ 
после подписи запроса и записи ключа на КТ.
%
Вместе с ключом на КТ сохраняются идентификационные данные субъекта,
которые РЦ получает у специальной доверенной службы. 
Взаимодействие РЦ и службы в настоящем стандарте не рассматривается.

\subsection{Подготовка запроса}\label{PROCESSES.Enroll.CSR}

Готовится запрос на получение сертификата. Формат запроса описан
в~\ref{FMT.CSR}. В запрос включается сгенерированный открытый ключ. 
Запрос подписывается на соответствующем личном ключе.

В~\texttt{Enroll1} субъект готовит запрос самостоятельно.
Субъект переносит в запрос идентификационные данные из своих 
удостоверений. Перенос может быть выполнен с помощью оператора РЦ.

Субъект должен включить в свой запрос атрибут~\texttt{extensionRequest}.
Атрибут заполняется в соответствии с правилами, изложенными в 
п.~\ref{FMT.CSR.ER}. Субъект должен указать в 
расширении~\texttt{subjectAltName} атрибута~\texttt{extensionRequest} 
свой адрес электронной почты (см. п.~\ref{ENTITIES.SAN}).

Субъект может указать в атрибуте~\texttt{challengePassword} запроса 
(см. п.~\ref{FMT.CSR.CP}) пароль отзыва сертификата (префикс~\str{/RPWD:})
и дополнительную информацию (префикс~\str{/INFO:}), которая позволит УЦ 
проверить факт оплаты услуг доверия, другие факты.
%
При конфигурировании~\texttt{Enroll} следует иметь в виду, что пароль 
отзыва приводится в запросе в открытом виде и может стать известным 
оператору РЦ. Неблагонадежный оператор может в будущем несанкционированно 
отозвать сертификат. Для снижения риска несанкционированного отзыва 
следует информировать субъекта о возможности смены пароля в будущем с помощью 
процесса~\texttt{Chpwd}.

В~\texttt{Enroll2} запрос готовит~РЦ, который взаимодействует с КТ 
субъекта в терминальном режиме. РЦ прочитывает с КТ идентификационные 
данные субъекта и сгенерированный открытый ключ.

В~\texttt{Enroll3} запрос готовит~РЦ, который получает идентификационные 
данные субъекта у специальной службы. Взаимодействие РЦ со службой в 
настоящем стандарте не рассматривается.

% todo: как заполняется challengePassword?

В~\texttt{Enroll4} субъект снова самостоятельно готовит запрос.
Субъект повторяет в запросе идентификационные данные, 
зарегистрированные в ИОК при предварительной аутентификации. 
%
Субъект обязательно указывает в запросе пароль~\texttt{enrollPwd}, 
полученный после аутентификации. Этот пароль задается в 
атрибуте~\texttt{challengePassword} запроса 
(см. п.~\ref{FMT.CSR.CP}) как пароль выпуска (префикс \str{/EPWD:}).
%
Способ доставки УЦ предварительно зарегистрированных 
идентификационных данных и пароля в настоящем стандарте 
не рассматривается.

\subsection{Аутентификация субъекта}\label{PROCESSES.Enroll.Auth}

Аутентификация состоит в проверке подлинности субъекта.
Аутентифицируется либо непосредственно субъект, либо его аппаратный КТ. 

В~\texttt{Enroll1} аутентификацию субъекта проводит оператор РЦ.
При аутентификации проверяются удостоверения субъекта. 

В~\texttt{Enroll2} аутентификацию аппаратного КТ проводит РЦ, который 
выступает в качестве терминала. Субъектом при этом может быть только 
ФЛ-резидент, для которого КТ является удостоверением. Правила 
аутентификации определены в СТБ 34.101.79. 
Аутентификация КТ выполняется до генерации ключей. 

В~\texttt{Enroll3} аутентификация не проводится.

В~\texttt{Enroll4} проводится предварительная аутентификация
с одновременной регистрацией идентификационных данных.

\subsection{Заверение запроса}\label{PROCESSES.Enroll.Signed}

Заверение состоит в подписи запроса. Заверяя запрос,
подписывающая сторона подтверждает подлинность указанных в нем сведений.
Подписанный запрос оформляется как контейнер \texttt{SignedData}.
Формат контейнера описан в п.~\ref{FMT.SignedData}. 
Контейнер включает сертификат подписанта.

В~\texttt{Enroll1} запрос заверяет оператор РЦ.
Оператор сверяет данные из удостоверений с данными в запросе.
%
Оператор~\doubt{должен} проверить владение ресурсами, описанными
дополнительными идентификационными атрибутами \texttt{email}, \texttt{DNS},
\texttt{URI}, \texttt{IP} (см. подраздел~\ref{ENTITIES.SAN}).

В~\texttt{Enroll2}, \texttt{Enroll3} запрос заверяет РЦ.
РЦ получает идентификационные данные от доверенных источников,
сам готовит по ним запрос и поэтому никаких проверок перед заверением
не проводит.

В~\texttt{Enroll4} запрос не заверяется.

\subsection{Отправка запроса}\label{PROCESSES.Enroll.Enveloped}

Подписанный запрос отправляется УЦ. Перед отправкой запрос конвертуется на 
открытом ключе УЦ и отправляется в виде контейнера~\texttt{EnvelopedData}. 
Формат контейнера описан в подразделе~\ref{FMT.EnvelopedData}. 
Конвертование запроса обеспечивает конфиденциальность содержащихся в нем 
идентификационных данных субъекта и его паролей.  

Открытый ключ УЦ определяется по его сертификату. Перед отправкой 
должна проверяться действительность сертификата.

В~\texttt{Enroll1} отправку выполняет оператор РЦ,
в~\texttt{Enroll2} и~\texttt{Enroll3}~--- РЦ,
в~\texttt{Enroll4}~--- сам субъект.

Перед отправкой запроса вычисляется его хэш-значение. 
В дальнейшем оно используется в качестве идентификатора запроса. 
Хэширование должно выполняться с помощью алгоритма 
\texttt{belt-hash} (см.~п.~\ref{CRYPTO.Hash}).
%
Идентификатор сохраняется вместе с ключевым контейнером или внутри 
аппаратного КТ.
%
Идентификатор можно не вычислять, если сохранить сам запрос и хэшировать 
его при необходимости.

\subsection{Обработка запроса}\label{PROCESSES.Enroll.Issue}

УЦ обрабатывает запрос по следующему алгоритму.

\begin{enumerate}
\item
Вычислить идентификатор запроса, применяя 
алгоритм хэширования~\texttt{belt-hash}. 
Запомнить идентификатор.

\item
Снять защиту с запроса как контейнера~\texttt{EnvelopedData} 
и определить вложенные в контейнер данные.

\item
Если в~\texttt{EnvelopedData} вложен контейнер~\texttt{SignedData}
(сценарии~\texttt{Enroll1}, \texttt{Enroll2} или~\texttt{Enroll3}), 
то выполнить следующие шаги:

\begin{enumerate}
\item
найти в контейнере \texttt{SignedData} сертификат отправителя
и проверить, что в его расширении \texttt{certificatePolicies} 
установлена роль РЦ (см. табл.~\ref{Table.ENTITIES.Roles});
\item
cвязать открытый ключ из сертификата отправителя с идентификатором 
запроса;
\item
проверить действительность подписи контейнера~\texttt{SignedData};
\item
извлечь из контейнера~\texttt{SignedData} запрос на получение сертификата;
\item
проверить подпись запроса на указанном в запросе открытом ключе;
\item
обработать атрибут~\texttt{challengePassword} запроса:
сохранить пароль отзыва, проверить дополнительную информацию
(при необходимости).
\end{enumerate}

\item
Если в~\texttt{EnvelopedData} вложен запрос на получение сертификата
(сценарий~\texttt{Enroll4}), то выполнить следующие шаги:
\begin{enumerate}
\item
проверить подпись запроса на указанном в запросе открытом ключе;
\item
cвязать открытый ключ из запроса с идентификатором запроса;
\item
сравнить указанные в запросе идентификационные данные с предварительно
зарегистрированными;
\item
обработать атрибут~\texttt{challengePassword} запроса:
проверить пароль выпуска (обязательно) и  
дополнительную информацию (при необходимости);
\end{enumerate}

\item
Выпустить сертификат:
\begin{enumerate}
\item
перенести в сертификат идентификационные данные из запроса;
\item
перенести в сертификат собственные идентификационные данные как эмитента;
\item
выбрать новый серийный номер сертификата;
\item
установить начало действия сертификата~-- текущий момент времени;
\item
окончание действия сертификата задать в соответствии с 
таблицей~\ref{Table.CERT.Validity} и с учетом дополнительной информации, 
переданной через~\texttt{challengePassword}; 
\item
сформировать расширения сертификата. Использовать правила,
изложенные в подразделе~\ref{FMT.Ext};
\item
подписать сертификат.
\end{enumerate}
\end{enumerate}

При ошибке на любом из шагов алгоритма обработка запроса 
прекращается с возвратом соответствующего кода ошибки.

Кроме выходных сертификата или кода ошибки 
УЦ дополнительно фиксирует идентификатор запроса (шаг 1)
и возможно связывает с ним открытый ключ (шаги 3.2, 4.2). 
Эти данные будут использоваться для подготовки ответа.

% \doubt{срок хранения?}

\subsection{Возврат ответа}\label{PROCESSES.Enroll.Resp}

По результатам обработки запроса УЦ формирует ответ: сертификат или 
контейнер типа \texttt{BPKIResp}, формат которого описан в 
подразделе~\ref{FMT.BPKIResp}.

В~\texttt{Enroll1}, \texttt{Enroll2}, \texttt{Enroll3}
cертификат конвертуется на открытом ключе отправителя запроса.
В~\texttt{Enroll4} сертификат конвертуется на открытом ключе самого сертификата. 
%
В любом случае используется открытый ключ, который был связан с 
идентификатором запроса при обработке запроса.

Контейнер \texttt{BPKIResp} возвращается при ошибке во время обработки
запроса. В компоненте~\texttt{requestId} контейнера указывается идентификатор 
запроса, а в компоненте~\texttt{statusInfo} описывается статус обработки 
запроса. Компонент~\texttt{nonce} опускается.
%
Контейнер \texttt{BPKIResp} подписывается, но не конвертуется.
%
Подписанный ответ оформляется как контейнер~\texttt{SignedData}.

% \doubt{Контейнер включает сертификат подписанта? т.е. УЦ?}

Контейнер \texttt{BPKIResp} возвращается также тогда,
когда обработка запроса не была завершена к моменту ответа.
В этом случае в контейнере указывается статус~\texttt{waiting}.

\subsection{Обработка ответа}\label{PROCESSES.Enroll.Finish}

Ответ УЦ получает та сторона, которая отправила запрос.
Отправитель не может полагаться на то, что сертификат
будет возвращен сразу (онлайн), даже если запрос корректен.
%
Тем не менее, УЦ должен гарантировать возврат ответа на корректный запрос  
в течение \doubt{24 часов.} 

Ответ, который не является ни контейнером типа~\texttt{EnvelopedData},
ни контейнером~\texttt{SignedData}, признается некорректным.

Если ответ представляет собой контейнер типа~\texttt{EnvelopedData}, 
то получатель снимает с него защиту на своем личном ключе, определяет 
вложенный сертификат и проверяет его действительность. 
%
В случае успеха сертификат передается субъекту (\texttt{Enroll1}),
записывается на КТ субъекта (\texttt{Enroll2} и~\texttt{Enroll3}),
либо субъект сам получает свой сертификат (\texttt{Enroll4}).
%
В~\texttt{Enroll1} сертификат дополнительно пересылается на указанный в 
нем адрес электронной почты (дополнительный идентификационный 
атрибут~\texttt{email}, см. п.~\ref{ENTITIES.SAN}). 

Если ответ представляет собой контейнер типа~\texttt{SignedData}, 
то получатель проверяет его подпись, определяет вложенный контейнер 
\texttt{BPKIResp} и анализирует его. Контейнер признается
корректным, если указанный в нем идентификатор~\texttt{requestId}
совпадает с первоначальным идентификатором запроса.
%
В конце концов получатель либо принимает ответ и обрабатывает указанный 
в нем статус обработки запроса, либо игнорирует ответ.

Если в~\texttt{BPKIResp} указан статус~\texttt{waiting}, то сертификат 
все-таки может быть получен через повторное обращение к УЦ с помощью 
процесса~\texttt{Retrieve}. В обращении должен использоваться 
идентификатор запроса. 
%
В~\texttt{Enroll1} идентификатор передается субъекту,
в~\texttt{Enroll2}~--- записывается на КТ субъекта,
в~\texttt{Enroll4} субъект сам получает идентификатор.
%
В~\texttt{Enroll3} РЦ не передает идентификатор субъекту, 
а самостоятельно выполняет процесс~\texttt{Retrieve}.

