\chapter{Программный интерфейс}\label{CRYPTOKI}

\section{Общие положения}\label{CRYPTOKI.Common}

PKCS\#11, принятый как СТБ 34.101.21, определяет программный
интерфейс взаимодействия с КТ. Интерфейс, называемый Cryptoki, определяет 
фиксированный набор функций языка Си, позволяющий выполнять широкий набор 
криптографических операций. 

Cryptoki оперирует такими понятиями, как ключевой объект и механизм.
%
В настоящем разделе уточняется использование введенных
в СТБ 34.101.21 объектов и вводятся новые механизмы для поддержки
алгоритмов СТБ 34.101.45.

Уточняются объект открытого ключа (см.~\ref{CRYPTOKI.Pubkey}) и объект
личного ключа (см.~\ref{CRYPTOKI.Privkey}). Используется стандартный механизм 
генерации объектов (см.~\ref{CRYPTOKI.Gen}). Сгенерированный личный 
ключ  сохраняется внутри КТ, открытый ключ экспортируется наружу для 
переноса в сертификат. Объекты используются в механизмах ЭЦП 
(см.~\ref{CRYPTOKI.SignHSpec}~--- \ref{CRYPTOKI.SignBash}) и транспорта   
ключа (см.~\ref{CRYPTOKI.Transport}).
%
В этих механизмах поддержка операций с открытым ключом (проверка ЭЦП и 
создание токена ключа) не является обязательной, операции можно выполнить 
за пределами КТ. Одна и та же пара ключей может использоваться в 
нескольких механизмах.

\section{Объекты}\label{CRYPTOKI.Obj}

\subsection{Параметры эллиптической кривой}\label{CRYPTOKI.Params}

В объектах открытого и личного ключа указывается 
идентификатор параметров ЭК, с которыми связан ключ объекта.
%
Должен использоваться идентификатор из перечня, заданного 
в~\ref{CRYPTO.Params}.
%
Идентификатор должен кодироваться по правилам DER и указываться в 
атрибуте~\verb|CKA_EC_PARAMS|.

Параметры ЭК однозначно определяют длины личного и открытого ключей, 
подписываемого хэш-значения и подписи: $l/4$, $l/2$, $l/4$ и $3l/8$ 
октетов соответственно, где~$l$~--- уровень стойкости (см.~\ref{CRYPTO}). 

В структуре~\verb|CK_MECHANISM_INFO|, описывающей криптографический 
механизм, необходимо зафиксировать факт использование параметров ЭК.
Для этого в поле флагов должны быть установлены следующие: 
\begin{itemize}
\item
\verb|CKF_EC_F_P|~--- используется ЭК над простым полем;
\item
\verb|CKF_EC_NAMEDCURVE|~--- параметры ЭК задаются идентификатором;
\item
\verb|CKF_EC_UNCOMPRESS|~--- точки ЭК задаются в несжатом виде.
\end{itemize}

\subsection{Объект открытого ключа}\label{CRYPTOKI.Pubkey}

Атрибуты объекта открытого ключа СТБ 34.101.45 
выбираются и настраиваются по правилам СТБ 34.101.21 со 
следующими уточнениями.

\begin{enumerate}
\item
Атрибут~\verb|CKA_CLASS| должен принимать значение~\verb|CKO_PUBLIC_KEY|.

\item
Атрибут~\verb|CKA_KEY_TYPE| должен принимать значение~\verb|CKK_EC|.

\item
Атрибут~\verb|CKA_DERIVE| должен принимать значение~\verb|CK_FALSE|.
% мехнизмы DH, MQV не введены, поэтому запрещаем derive.

\item
Атрибут~\verb|CKA_TOKEN| должен принимать значение~\verb|CK_TRUE|,
если ключ хранится в КТ, иначе ключ хранится в памяти библиотеки и
является сеансовым.

\item
В атрибуте~\verb|CKA_EC_PARAMS| должен быть задан идентификатор связанных 
параметров ЭК (см.~\ref{CRYPTOKI.Params}).

\item
В атрибуте~\verb|CKA_EC_POINT| задается значение открытого ключа. 
Атрибут должен использоваться для создания объекта открытого ключа 
по значению открытого ключа либо для извлечения значения из объекта. 

\item
В атрибуте~\verb|CKA_ID| задается идентификатор открытого ключа. 
Атрибут должен использоваться в тех случаях, когда на КТ  
хранятся несколько открытых ключей, и требуется выбирать один из них. 
%
Атрибут~\verb|CKA_ID| должен быть согласован с одноименным атрибутом 
объекта личного ключа.

\item
Атрибут \verb|CKA_VERIFY| должен принимать значение~\verb|CK_TRUE| 
только если открытый ключ планируется использовать для проверки ЭЦП.
\addendum{Значение по умолчанию зависит от реализации.}

\item
Атрибут \verb|CKA_WRAP| должен принимать значение~\verb|CK_TRUE|
только если открытый ключ планируется использовать для создания
токена ключа.
\addendum{Значение по умолчанию зависит от реализации.}

\item
В атрибуте \verb|CKA_ALLOWED_MECHANISMS| должен быть указан список 
идентификаторов механизмов, с которыми разрешается использовать
открытый ключ. Механизмы должны быть согласованы с уровнем стойкости 
ключа. Атрибут может указываться при создании открытого
ключа или генерации пары ключей для ограничения использования
открытого ключа. 
\end{enumerate}
 
Ниже приведен пример шаблона для генерации объекта открытого ключа СТБ 34.101.45:
\begin{verbatim}
CK_OBJECT_CLASS class = CKO_PUBLIC_KEY;
CK_KEY_TYPE keyType = CKK_EC;
CK_UTF8CHAR label[] = "bign128-pubkey";
CK_BYTE bignParams[] = {
  0x06,0x0A,0x2A,0x70,0x00,0x02,
  0x00,0x22,0x65,0x2D,0x03,0x01};
CK_BYTE id[] = {1};
CK_MECHANISM_TYPE mechanisms[] = {
  CKM_BIGN, CKM_BIGN_TSP };
CK_BBOOL true = CK_TRUE;
CK_ATTRIBUTE template[] = {
  {CKA_CLASS, &class, sizeof(class)},
  {CKA_KEY_TYPE, &keyType, sizeof(keyType)},
  {CKA_TOKEN, &true, sizeof(true)},
  {CKA_LABEL, label, sizeof(label) - 1},
  {CKA_EC_PARAMS, bignParams, sizeof(bignParams)},
  {CKA_ID, id, sizeof(id)},
  {CKA_VERIFY, &true, sizeof(true)},
  {CKA_WRAP, &true, sizeof(true)},
  {CKA_ALLOWED_MECHANISMS, mechanisms, sizeof(mechanisms)},
};
\end{verbatim}

\subsection{Объект личного ключа}\label{CRYPTOKI.Privkey}

%2.3.4

Атрибуты объекта личного ключа СТБ 34.101.45 
выбираются и настраиваются по правилам СТБ 34.101.21 со 
следующими уточнениями.

\begin{enumerate}
\item
Атрибут~\verb|CKA_CLASS| должен принимать значение~\verb|CKO_PRIVATE_KEY|.

\item
Атрибут~\verb|CKA_KEY_TYPE| должен принимать значение~\verb|CKK_EC|.

\item
Атрибут~\verb|CKA_DERIVE| должен принимать значение~\verb|CK_FALSE|.

\item
Атрибут~\verb|CKA_TOKEN| должен принимать значение~\verb|CK_TRUE|,
если ключ хранится в КТ, иначе ключ хранится в памяти библиотеки и
является сеансовым.

\item
В атрибуте~\verb|CKA_EC_PARAMS| должен быть задан идентификатор связанных
параметров ЭК (см.~\ref{CRYPTOKI.Params}).

\item
В атрибуте~\verb|CKA_VALUE| задается значение личного ключа.
Атрибут может использоваться для создания объекта сеансового личного ключа,
не хранимого на КТ, либо для извлечения значения сеансового личного ключа
из объекта.

\item
В атрибуте~\verb|CKA_ID| задается идентификатор личного ключа.
Атрибут должен использовать в тех случаях, когда в КТ
хранятся несколько личных ключей, и требуется выбирать один из них. 
%
Значение атрибута \verb|CKA_ID| запрещается изменять
после его назначения объекту личного ключа.

\begin{note}
\doubt{Примечание}~---
При идентификации личных ключей КТ, соответствующих СТБ 34.101.79,
атрибут должен состоять из одного~байта.
\end{note}

\item
Атрибут~\verb|CKA_SIGN| должен принимать значение~\verb|CK_TRUE|
только если личный ключ планируется использовать для выработки ЭЦП.
\addendum{Значение по умолчанию зависит от реализации.}

\item
Атрибут~\verb|CKA_UNWRAP| должен принимать значение~\verb|CK_TRUE|
только если личный ключ планируется использовать для разбора
токена ключа.
\addendum{Значение по умолчанию зависит от реализации.}

\item
В атрибуте \verb|CKA_ALLOWED_MECHANISMS| должен быть указан список 
идентификаторов механизмов, с которыми разрешается использовать
личный ключ. Механизмы должны быть согласованы с уровнем стойкости 
ключа. Атрибут может указываться при создании личного
ключа или генерации пары ключей для ограничения использования
личного ключа. 

\item
Атрибут~\verb|CKA_SENSITIVE| должен принимать значение~\verb|CK_TRUE|,
если ключ не может быть извлечен ни в каком виде.
\addendum{Значение по умолчанию зависит от реализации.}

\begin{note}
\doubt{Примечание}~---
Личные ключи КТ, соответствующие СТБ 34.101.79, должны быть неизвлекаемые,
значение атрибута~\verb|CKA_SENSITIVE| должно быть~\verb|CK_TRUE| и
не может быть изменено.
\end{note}

\item
Атрибут~\verb|CKA_EXTRACTABLE| должен принимать значение~\verb|CK_TRUE|,
если личный ключ может быть извлечен с помощью транспорта ключа.
\addendum{Значение по умолчанию зависит от реализации.}

\begin{note}
\doubt{Примечание}~---
Личные ключи КТ, соответствующие СТБ 34.101.79, должны быть неизвлекаемые,
значение атрибута~\verb|CKA_EXTRACTABLE| должно быть~\verb|CK_FALSE| и
не может быть изменено.
\end{note}

\end{enumerate}

Ниже приведен пример шаблона для генерации объекта личного ключа СТБ 34.101.45:
\begin{verbatim}
CK_OBJECT_CLASS class = CKO_PRIVATE_KEY;
CK_KEY_TYPE keyType = CKK_EC;
CK_BYTE id[] = {1};
CK_UTF8CHAR label[] = "bign128-privkey";
CK_MECHANISM_TYPE mechanisms[] = {
  CKM_BIGN, CKM_BIGN_TSP };
CK_BBOOL true = CK_TRUE;
CK_ATTRIBUTE template[] = {
  {CKA_CLASS, &class, sizeof(class)},
  {CKA_KEY_TYPE, &keyType, sizeof(keyType)},
  {CKA_ID, id, sizeof(id)},
  {CKA_TOKEN, &true, sizeof(true)},
  {CKA_SENSITIVE, &true, sizeof(true)},
  {CKA_EXTRACTABLE, &false, sizeof(false)},
  {CKA_LABEL, label, sizeof(label) - 1},
  {CKA_SIGN, &true, sizeof(true)},
  {CKA_UNWRAP, &true, sizeof(true)},
  {CKA_ALLOWED_MECHANISMS, mechanisms, sizeof(mechanisms)},
};
\end{verbatim}

Этот же шаблон может быть использован для поиска личного ключа.

\section{Механизмы}
                                                                                                                 
\subsection{Механизм CKM\_EC\_KEY\_PAIR\_GEN}\label{CRYPTOKI.Gen}

%2.3.5

Для генерации ключей СТБ 34.101.45 должен использоваться стандартный 
механизм \verb|CKM_EC_KEY_PAIR_GEN|. Механизм не имеет параметров. 

Механизм поддерживается функцией~\verb|C_GenerateKeyPair|. 
%
Описатель механизма и шаблоны объектов открытого и личного
ключей подаются на вход~\verb|C_GenerateKeyPair|. Параметры ЭК задаются в 
атрибуте \verb|CKA_EC_PARAMS| шаблона открытого ключа.

\addendum{Механизм} однозначно определяет атрибуты
\verb|CKA_CLASS|, \verb|CKA_KEY_TYPE| и \verb|CKA_EC_POINT|
объекта открытого ключа и атрибуты
\verb|CKA_CLASS|, \verb|CKA_KEY_TYPE|, \verb|CKA_EC_PARAMS| и 
\verb|CKA_VALUE| объекта личного ключа,
поэтому указанные атрибуты могут не указываться в
соответствующих шаблонах.

\begin{note}
\doubt{Примечание}~---
\doubt{При генерации} ключей КТ, соответствующих СТБ 34.101.79,
уровень стойкости, неявно определяемый атрибутом \verb|CKA_ID| личного ключа,
должен соответствовать параметрам ЭК, указываемым в атрибуте 
\verb|CKA_EC_PARAMS| открытого ключа. \doubt{Значения атрибутов} 
\verb|CKA_SIGN| личного ключа и \verb|CKA_VERIFY| открытого ключа должны 
совпадать. \doubt{Значения атрибутов} \verb|CKA_UNWRAP| личного ключа и 
\verb|CKA_WRAP| открытого ключа должны совпадать. 
\end{note}

\doubt{Q: во-первых, о BTOK лучше говорить как можно меньше (лучше в BTOK 
сказать о настройке Cryptoki. По идентификатору определяется уровень? Но 
ведь на КТ мб несколько ключей одного уровня. Связь флагов спорная (или я 
чего-то не понимаю)} 

\doubt{A: Здесь имелось ввиду соответствие уровень-ссылка из btok: 128-1, 192-2, 256-3.
Связь флагов означает, что если лк можно использовать для выработки подписи,
то ок можно использовать для проверки, и наоборот. Аналогично для транспорта.
Если такого соответствия не будет, то получится странная ситуация - подпись есть,
но ее нельзя проверить, или есть токен, но его нельзя разобрать.}

\subsection{Механизм CKM\_BIGN}\label{CRYPTOKI.SignHSpec}

Для выработки ЭЦП в соответствии с СТБ 34.101.45 по заданному хэш-значению 
сообщения должен использоваться механизм \verb|CKM_BIGN|. Механизм может 
дополнительно реализовывать проверку ЭЦП. 
%
Параметром механизма (указывается в описателе механизма~--- 
структуре~\verb|CK_MECHANISM|) является DER-код идентификатора 
используемого алгоритма хэширования.

Идентификатор механизма: \texttt{0x00008001} 
(синтаксис языка Си, принятый в СТБ 34.101.21). 

Механизм поддерживается функциями выработки и проверки ЭЦП: 
\verb|C_SignInit|, \verb|C_Sign|, \verb|C_VerifyInit|, \verb|C_Verify|.

При выработке подписи описатели сеанса, механизма и объекта
личного ключа подаются на вход функции \verb|C_SignInit|.
Описатель сеанса, указатели на подписываемое хэш-значение и выходное 
значение подписи вместе с их размерами подаются на вход функции 
\verb|C_Sign|.

При проверке подписи описатели сеанса, механизма и объекта
открытого ключа подаются на вход функции \verb|C_VerifyInit|.
Описатель сеанса, указатели на подписанное хэш-значение и значение подписи 
вместе с их размерами подаются на вход функции \verb|C_Verify|.

Длины входных и выходных данных (хэш-значение, подпись) функций
\verb|C_Sign| и \verb|C_Verify| должны соответствовать
уровню стойкости~$l$ соответствующего ключевого объекта.

Могут поддерживаться только определенные алгоритмы хэширования.
При отсутствии поддержки функции \verb|C_SignInit|,
\verb|C_VerifyInit| должны возвращать код 
\verb|CKR_MECHANISM_PARAM_INVALID|.

\subsection{Механизм CKM\_BIGN\_HBELT}\label{CRYPTOKI.SignHBelt}

Для выработки ЭЦП в соответствии с алгоритмами~\texttt{bign-with-hbelt} 
(см.~\ref{CRYPTO.Sign}) должен использоваться механизм \verb|CKM_BIGN_HBELT|. 
Механизм может дополнительно реализовывать проверку ЭЦП. 
%
Механизм не имеет параметров.

Идентификатор механизма: \texttt{0x00008002}.

Механизм поддерживается функциями выработки и проверки ЭЦП: 
\verb|C_SignInit|, \verb|C_SignUpdate|, \verb|C_SignFinal|, 
\verb|C_VerifyInit|, \verb|C_VerifyUpdate|, \verb|C_VerifyFinal|.

При выработке подписи описатели сеанса, механизма и объекта
личного ключа подаются на вход функции \verb|C_SignInit|.
Описатель сеанса, подписываемые данные целиком или по частям подаются
на вход функции \verb|C_SignUpdate|.
Описатель сеанса, указатель на выходное значение подписи вместе с размером
подаются на вход функции \verb|C_SignFinal|.

При проверке подписи описатели сеанса, механизма и объекта
открытого ключа подаются на вход функции \verb|C_VerifyInit|.
Описатель сеанса, подписанные данные целиком или по-частям подаются
на вход функции \verb|C_VerifyUpdate|.
Описатель сеанса, указатель на значение подписи вместе с размером
подаются на вход функции \verb|C_VerifyFinal|.

В механизме должны использоваться ключи уровня стойкости $l=128$ 
и стандартные параметры ЭК этого уровня (см.~\ref{CRYPTO.Params}).
% 
Буфер подписи, подаваемый на вход функций \verb|C_SignFinal| и 
\verb|C_VerifyFinal|, должен состоять из 48 октетов.

\subsection{Механизм CKM\_BIGN\_BASH}\label{CRYPTOKI.SignBash}

Для выработки ЭЦП в соответствии с алгоритмами~\texttt{bign-with-bash384},
\texttt{bign-with-bash512} (см.~\ref{CRYPTO.Sign}) должен использоваться 
механизм \verb|CKM_BIGN_BASH|. Механизм может дополнительно реализовывать 
проверку ЭЦП. 
%
Механизм не имеет параметров.

Идентификатор механизма: \texttt{0x00008003}.

Механизм~\verb|CKM_BIGN_BASH| поддерживается теми же функциями и по тем же 
правилам, что и механизм~\verb|CKM_BIGN_HBELT|.

В механизме должны использоваться ключи уровней стойкости $l=192$ и~$l=256$
и стандартные параметры ЭК этих уровней (см.~\ref{CRYPTO.Params}).
% 
Буфер подписи, подаваемый на вход функций \verb|C_SignFinal| и 
\verb|C_VerifyFinal|, должен состоять из 72 ($l=192$) или 96 ($l=256$) 
октетов. 

\addendum{Механизм может дополнительно реализовывать алгоритмы 
\texttt{bign-with-bash256}: связку алгоритмов ЭЦП СТБ 34.101.45 c 
алгоритмом хэширования \texttt{bash256}, определенным в СТБ 34.101.77.
При этом должны использоваться ключи уровня стойкости~$l=256$
и стандартные параметры ЭК этого уровня. Буфер подпииси должен состоять 
из~$48$ октетов.
}

\subsection{Механизм CKM\_BIGN\_TSP}\label{CRYPTOKI.Transport}

%2.3.12

Для разбора токена ключа в соответствии с алгоритмами~\texttt{bign-keytransport}
(см.~\ref{CRYPTO.Transport}) должен использоваться механизм \verb|CKM_BIGN_TSP|. 
Механизм может дополнительно реализовывать создание токена ключа.
%
Параметр механизма~-- заголовок транспортируемого ключа (16~октетов). 
Параметр может опускаться, и тогда должен использоваться
заголовок из 16~нулевых октетов.

Идентификатор механизма: \texttt{0x00008004}.

Механизм подерживается функциями создания и разбора токена ключа:
\verb|C_WrapKey| и \verb|C_UnwrapKey|.

При создании токена на вход функции \verb|C_WrapKey| подаются
описатель сеанса, описатель механизма, описатели объектов открытого ключа
получателя и транспортируемого ключа, указатель на
выходное значение токена ключа вместе с размером.
Размер транспортируемого ключа должен быть не менее 16 октетов.
Объект транспортируемого ключа может иметь произвольный класс и тип.

При разборе токена на вход функции \verb|C_UnwrapKey| подаются
описатель сеанса, описатель механизма, описатель объекта личного ключа
получателя, указатель на значение токена ключа вместе с размером,
набор атрибутов для создания нового ключа и указатель,
который на выходе получает описатель на созданный ключ.
Размер токена ключа должен быть не менее 32 октетов.
Объект нового ключа может иметь произвольный класс и тип.

\section{Программная библиотека}\label{CRYPTOKI.Lib}

Программная библиотека, реализующая интерфейс Cryptoki,
дополнительно к описанным выше функциям криптографических механизмов 
должна включать следующие функции:
\begin{itemize}
\item
\verb|C_Initialize|~--- инициализация библиотеки;
\item
\verb|C_GetInfo|~--- получение информации о библиотеке;
\item
\verb|C_GetFunctionList|~--- получение указателей на реализации функций;
\item
\verb|C_GetSlotList|~--- перечисление слотов в системе;
\item
\verb|C_GetSlotInfo|~--- получение информации о слоте;
\item
\verb|C_GetTokenInfo|~--- получение информации о КТ, находящемся в 
выбранном слоте;
\item
\verb|C_GetMechanismList|~--- 
получение списка механизмов, поддерживаемых КТ;
\item
\verb|C_OpenSession|~--- открытие сеанса работы с КТ;
\item
\verb|C_Login|~--- парольная аутентификация пользователя перед КТ;
\item
\verb|C_FindObjectsInit|, \verb|C_FindObjects|, 
\verb|C_FindObjectsFinal|~---
поиск объекта на основании шаблона;
\item[--]
\verb|C_GetAttributeValue|~--- получение атрибутов объекта;
\item[--]
\verb|C_Logout|~--- завершение работы с критическими объектами КТ;
\item[--]
\verb|C_CloseSession|~--- завершение сеанса работы с КТ;
\item[--]
\verb|C_Finalize|~--- завершение работы с библиотекой.
\end{itemize}

Функции должны быть реализованы в соответствии с СТБ 34.101.21.
Схема работы с функциями также определена в СТБ 34.101.21.

Параметром функции \verb|C_Login| является пароль владельца КТ.
Пароль может содержать любые символы UTF-8, кроме \str{:} 
(графический код байта $58=\hex{3A}$). Пароль может сопровождаться 
служебной информацией: тип пароля, настройки состояния владельца,
разрешения владельца на доступ к объектам. 
%
Пример пароля вместе со служебной информацией: \str{1123581321:PUK}. 

\addendum{Экспорт открытого ключа} может быть выполнен
с помощью функции \verb|C_GetAttributeValue|. в шаблоне запрашиваемых 
атрибутов, передаваемом на вход функции, следует указать \verb|CKA_EC_POINT|.

\doubt{Q: export только при разрешении? или всегда? (настойка атрибутов)} 

\doubt{A: Экспорт ок разрешен всегда.}

\doubt{Q: можно ли что-то сократить (сделать обязательным при 
выполнении условий)?}

\doubt{A:
Нельзя говорить, что должен быть реализован какой-то
поднабор, т.к. должны быть реализованы все функции Cryptoki.
Можно говорить о наборе функций, которые могут использоваться
в какой-то КП в том или ином сценарии, но нельзя ограничивать
набор только этими функциями - это идет в разрез с Cryptoki.
Другая КП может использовать другие функции Cryptoki.
}

\doubt{Q: хорошо. Нужно реализовать все функции. Но зачем FindObj, 
еслм ключ только один}.

\doubt{A: Для получения описателя объекта. (Иначе - только через
создание/генерацию.)}

\if 0
\section{Сценарий работы}

В этом разделе рассматривается типовой сценарий работы,
включающий следующие шаги: выбор токена стороннего
производителя, аутентификация с помощью PIN-кода, выбор
личного ключа и выработка подписи, завершение работы.
Для каждого шага описываются основные действия и
уточняются, где это необходимо, аргументы функций Cryptoki,
используемых при этом.
Сами функции, принимаемые аргументы и примеры
их использования определены в СТБ 34.101.21.

Производитель токенов должен предоставить библиотеку,
реализующую интерфейс Cryptoki. Перед началом работы прикладная
программа, желающая работать с токенами конкретного
производителя, должна загрузить соответствующую библиотеку
Cryptoki. Библиотека OpenSC реализует Cryptoki и позволяет
взаимодействовать со смарт-картами многих производителей.

\subsection{Начало работы и выбор токена}

% функции общего назначения
В начале работы библиотека Cryptoki должна быть
проинициализирована с помощью функции \verb|C_Initialize|.

Получить информацию о библиотеке, в т.~е. версию интерфейса
Cryptoki, идентификатор производителя, описание и версию
библиотеки, можно с помощью функции \verb|C_GetInfo|.
\doubt{Эта функция может быть использована для подтверждения
возможности работы согласно Cryptoki необходимой версии,
а также с токенами конкретного производителя.}

Затем требуется получить список указателей на функции Cryptoki
с помощью \verb|C_GetFunctionList|.

% функции управления слотами и токенами
Следующим этапом требуется выбрать слот -- логическое
устройство чтения токенов (например, считыватель смарт-карт),
а затем токен.
Функция \verb|C_GetSlotList| возвращает список слотов в системе.

Для получения информации о слоте, включая описание слота,
идентификатор производителя, версии прошивки и аппаратной
части слота, используется функция \verb|C_GetSlotInfo|.
\doubt{Эта функция может быть использована для потверждения
выбора требуемого слота.}

Для получения информации о токене, находящемся в выбранном
слоте, используется функция \verb|C_GetTokenInfo|.
Функция возвращает метку токена, идентификатор производителя,
модель и серийный номер токена, версии прошивки и
аппаратной части токена.
\doubt{Эта функция может быть использована для потверждения
выбора требуемого токена.}

Для получения списка механизмов, поддерживаемых токеном,
используется функция \verb|C_GetMechanismList|.
\doubt{Эта функция может быть использована для потверждения
поддержки токеном механизмов, определенных в настоящем
стандарте.}

%TODO: Этот подраздел можно сократить до:
%Библиотека должна поддерживать Cryptoki версии не ниже 2.20.
%Токен должен поддерживать механизмы, описанные в данном стандарте.

\subsection{Аутентификация}

% функции управления сессиями
После поиска и выбора токена требуется открыть сеанс
взаимодействия между прикладной программой и токеном с
помощью функции \verb|C_OpenSession|.

Для аутентификации пользователя перед токеном в рамках
выбранной сессии требуется вызвать функцию \verb|C_Login|.

Успешное выполнение функции \verb|C_Login| разрешает
выполнение команд с критическими объектами (ключами).

\doubt{Токены согласно СТБ 34.101.btok при аутентификации
принимают дополнительный параметр, определяющий количество
выработок подписей без дополнительного подтверждения PIN-кода.}
Функции \verb|C_OpenSession| и \verb|C_Login| не принимают
дополнительные параметры, которые можно использовать для
изменения их поведения.

%TODO:
%Количество выработок подписей можно передавать как первый или
%последний байт PIN-кода, но прикладная программа и библиотека
%должны поддерживать такое поведение, не соответствующее
%интерфейсу Cryptoki.

\subsection{Выбор личного ключа}

% функции управления объектами
Выработать пару ключей можно с помощью функции
\verb|C_GenerateKeyPair|, на вход которой подаются атрибуты
объектов открытого и личного ключей.

Выбор существующих ключей выполняется с помощью функций
поиска объектов. Функция \verb|C_FindObjectsInit| инициализации
поиска объекта позволяет задать критерии поиска на основании
шаблона, в котором указываются атрибуты искомого объекта.
Функция \verb|C_FindObjects| возвращает описатели объектов,
удовлетворяющих шаблону. Функция \verb|C_FindObjectsFinal|
завершает поиск.

При создании шаблона объекта личного ключа для однозначной
идентификации объекта следует указывать атрибут \verb|CKA_ID|.

Функции генерации и поиска возвращают описатели ключевых
объектов, которые могут быть использованы при выработке подписи
и транспорте ключа.

%TODO: Этот подраздел можно сократить до:
%При генерации и выборе личных ключей нужно указывать
%атрибут \verb|CKA_ID|.

%\subsection{Выработка подписи}
%\subsection{Создание запроса на выпуск сертификата}
%\subsection{Транспорт ключа}

\subsection{Завершение работы}

Для завершения работы с критическими объектами токена
используется функция \verb|C_Logout|.

Для завершения сеанса работы с токеном используется функция
\verb|C_CloseSession|.

Для завершения работы и деинициализации библиотеки
используется функция \verb|C_Finalize|.
\fi
