\chapter{Программный интерфейс}\label{CRYPTOKI}

\section{Общие положения}

PKCS\#11, принятый как СТБ 34.101.21, определяет программный
интерфейс взаимодействия с КТ, называемый Cryptoki.
Интерфейс содержит фиксированный набор функций, позволяющий
выполнять широкий набор криптографических команд.

Cryptoki оперирует такими понятиями, как механизм и ключевой объект.
%
В настоящем разделе уточняется использование введенных
в СТБ 34.101.21 объектов и вводятся новые механизмы для поддержки
алгоритмов СТБ 34.101.45 (генерация ключей, ЭЦП, транспорт ключа).

\section{Объекты}

\subsection{Атрибуты}

Объектам Cryptoki назначаются атрибуты: класс, тип, описание и др. 
%
Набор атрибутов формирует шаблон объекта.
%
В зависимости от контекста атрибуты подчиняются тем или иным правилам.
Правила, задействованные в настоящем стандарте, собраны в
таблице~\ref{Table.CRYPTOKI.AttrUse}. Далее при описании атрибута будут
указываться номера правил из таблицы.

\begin{table}[H]
\caption{Правила использования атрибутов}\label{Table.CRYPTOKI.AttrUse}
\begin{tabular}{|c|p{420pt}|}
\hline
Номер & Правило\\
\hline
\hline
1 & ДОЛЖЕН быть указан при создании объекта с помощью
\verb|C_CreateObject|\\
\hline
3 & ДОЛЖЕН быть указан при генерации объекта с помощью
\verb|C_GenerateKey| или \verb|C_GenerateKeyPair|\\
\hline
4 & НЕ ДОЛЖЕН быть указан при генерации объекта с помощью
\verb|C_GenerateKey| или \verb|C_GenerateKeyPair|\\
\hline
6 & НЕ ДОЛЖЕН быть указан при извлечении объекта с помощью
\verb|C_UnwrapKey|\\
\hline
7 & НЕ МОЖЕТ быть раскрыт, если объект имеет атрибут
\verb|CKA_SENSITIVE| со значением \verb|CK_TRUE| или атрибут
\verb|CKA_EXTRACTABLE| со значением \verb|CK_FALSE|\\
\hline
\end{tabular}
\end{table}

\subsection{Параметры эллиптической кривой}

Если в криптографическом механизме используются параметры ЭК
(см.~\ref{CRYPTO.Params}), то в соответствующей
структуре~\verb|CK_MECHANISM_INFO| должны быть установлены 
следующие флаги: 
\begin{itemize}
\item[--]
\verb|CKF_EC_F_P|~--- используется ЭК над простым полем;
\item[--]
\verb|CKF_EC_NAMEDCURVE|~--- параметры ЭК задаются идентификатором;
\item[--]
\verb|CKF_EC_UNCOMPRESS|~--- точки ЭК задаются в несжатом виде.
\end{itemize}

Должны использоваться стандартные параметры ЭК
(см.~\ref{CRYPTO.Params}).
Идентификатор параметров ЭК должен кодироваться по правилам
DER и указываться как значение атрибута \verb|CKA_EC_PARAMS|.

Параметры ЭК однозначно определяют длины личного и открытого ключей, 
подписываемого хэш-значения и подписи: $l/4$, $l/2$, $l/4$ и $3l/8$ 
октетов соответственно, где~$l$~--- уровень стойкости (см.~\ref{CRYPTO}). 

\subsection{Объект открытого ключа}

%2.3.3

Объект открытого ключа СТБ 34.101.45 должен принадлежать
классу \verb|CKO_PUBLIC_KEY| и иметь тип ключа \verb|CKK_EC|.
%
В таблице~\ref{Table.CRYPTOKI.EcPubkeyAttrs} указаны
атрибуты объекта, дополнительные к обычным атрибутам 
класса~\verb|CKO_PUBLIC_KEY|.
% СТБ 34.101.21, разделы 10.2, 10.7, 10.8.

\begin{table}[H]
\caption{Атрибуты объекта открытого ключа}\label{Table.CRYPTOKI.EcPubkeyAttrs}
\begin{tabular}{|c|c|c|c|}
\hline
Атрибут & Правила & Тип & Значение\\
\hline
\hline
\verb|CKA_EC_PARAMS| & 1, 3 & Совокупность байтов &
параметры ЭК\\
\hline
\verb|CKA_EC_POINT| & 1, 4 & Совокупность байтов &
значение открытого ключа, $l/2$ октетов\\
\hline
\end{tabular}
\end{table}

\addendum{Атрибут} \verb|CKA_EC_POINT| может использоваться для
создания объекта окрытого ключа либо для извлечения
значения открытого ключа из объекта.

\addendum{Атрибут} \verb|CKA_ID| является необязательным и может
использоваться для идентификации открытых ключей.
Значение атрибута может быть пустым либо должно быть уникальным.

\addendum{Атрибут} \verb|CKA_VERIFY| указывает возможность
использования открытого ключа для проверки подписи.
Атрибут \verb|CKA_WRAP| указывает возможность
использования открытого ключа для создания токена ключа.
Значения по умолчанию атрибутов \verb|CKA_VERIFY| и \verb|CKA_WRAP|
зависят от исполнения КТ и других атрибутов.

\addendum{Атрибут} \verb|CKA_ALLOWED_MECHANISMS| содержит список
идентификаторов механизмов, с которыми разрешается использовать
открытый ключ. Атрибут может указываться при создании открытого
ключа или генерации пары ключей для ограничения использования
открытого ключа.

Ниже приведен пример шаблона для генерации объекта открытого ключа СТБ 34.101.45:
\begin{verbatim}
CK_OBJECT_CLASS class = CKO_PUBLIC_KEY;
CK_KEY_TYPE keyType = CKK_EC;
CK_UTF8CHAR label[] = "bign128-pubkey";
CK_BYTE bignParams[] = {
  0x06,0x0A,0x2A,0x70,0x00,0x02,
  0x00,0x22,0x65,0x2D,0x03,0x01};
CK_MECHANISM_TYPE mechanisms[] = {
  CKM_BIGN, CKM_BIGN_TSP };
CK_BBOOL true = CK_TRUE;
CK_ATTRIBUTE template[] = {
  {CKA_CLASS, &class, sizeof(class)},
  {CKA_KEY_TYPE, &keyType, sizeof(keyType)},
  {CKA_TOKEN, &true, sizeof(true)},
  {CKA_LABEL, label, sizeof(label) - 1},
  {CKA_EC_PARAMS, bignParams, sizeof(bignParams)},
  {CKA_ALLOWED_MECHANISMS, mechanisms, sizeof(mechanisms)},
};
\end{verbatim}

\addendum{Объект открытого ключа не может быть восстановлен по
личному ключу.}

\subsection{Объект личного ключа}

%2.3.4

Объект личного ключа СТБ 34.101.45 должен принадлежать
классу~\verb|CKO_PRIVATE_KEY| и иметь тип ключа~\verb|CKK_EC|.
В таблице~\ref{Table.CRYPTOKI.EcPrivkeyAttrs} указаны
атрибуты объекта личного ключа, дополнительные к обычным
атрибутам класса~\verb|CKO_PRIVATE_KEY|.
% СТБ 34.101.21, разделы 10.2, 10.7, 10.9.

\begin{table}[H]
\caption{Атрибуты объекта личного ключа}\label{Table.CRYPTOKI.EcPrivkeyAttrs}
\begin{tabular}{|c|c|c|c|}
\hline
Атрибут & Правила & Тип & Значение\\
\hline
\hline
\verb|CKA_EC_PARAMS| & 1, 4, 6 & Совокупность байтов &
параметры ЭК\\
\hline
\verb|CKA_VALUE| & 1, 4, 6, 7 & Совокупность байтов &
личный ключ, $l/4$ октетов\\
\hline
\end{tabular}
\end{table}

\addendum{Атрибут} \verb|CKA_VALUE| может использоваться для
создания объекта сеансового личного ключа, не хранимого на КТ, либо для извлечения значения сеансового личного ключа из объекта.

Атрибут \verb|CKA_ID| является необязательным. 
Его следует использовать тогда, когда на КТ хранятся 
несколько личных ключей, и требуется выбирать один из них.

\begin{note}
Примечание~---
При идентификации личных ключей КТ, соответствующих СТБ 34.101.79,
атрибут должен состоять из одного~байта.
\end{note}

Значение атрибута \verb|CKA_ID| запрещается изменять
после его назначения объекту личного ключа.
%согласно СТБ 34.101.21 CKA_ID можно изменять

\addendum{Атрибут} \verb|CKA_SIGN| указывает возможность
использования личного ключа для выработки подписи.
Атрибут \verb|CKA_UNWRAP| указывает возможность
использования личного ключа для разбора токена ключа.
Значения по умолчанию атрибутов \verb|CKA_SIGN| и \verb|CKA_UNWRAP|
зависят от исполнения КТ и других атрибутов.

\addendum{Атрибут} \verb|CKA_ALLOWED_MECHANISMS| содержит список
идентификаторов механизмов, с которыми разрешается использовать
личный ключ. Атрибут может указываться при создании личного
ключа или генерации пары ключей для ограничения использования
личного ключа.

\addendum{Атрибуты} \verb|CKA_TOKEN|, \verb|CKA_ALWAYS_SENSITIVE|, \verb|CKA_NEVER_EXTRACTABLE|
личных ключей КТ, соответствующих СТБ 34.101.79,
должны иметь значение \verb|CK_TRUE|.
\doubt{Здесь можно определить CKA\_SENSITIVE, CKA\_EXTRACTABLE,
но это внесло бы неясности, т.к. эти значения можно изменять.}

Личный ключ генерируется только как часть пары ключей,
при генерации параметры ЭК указываются только в шаблоне
открытого ключа (\addendum{хотя шаблон личного ключа также передается в 
функцию генерации}).

Ниже приведен пример шаблона для генерации объекта личного ключа СТБ 34.101.45:
\begin{verbatim}
CK_OBJECT_CLASS class = CKO_PRIVATE_KEY;
CK_KEY_TYPE keyType = CKK_EC;
CK_BYTE id[] = {1};
CK_UTF8CHAR label[] = "bign128-privkey";
CK_MECHANISM_TYPE mechanisms[] = {
  CKM_BIGN, CKM_BIGN_TSP };
CK_BBOOL true = CK_TRUE;
CK_ATTRIBUTE template[] = {
  {CKA_CLASS, &class, sizeof(class)},
  {CKA_KEY_TYPE, &keyType, sizeof(keyType)},
  {CKA_ID, id, sizeof(id)},
  {CKA_TOKEN, &true, sizeof(true)},
  {CKA_SENSITIVE, &true, sizeof(true)},
  {CKA_DERIVE, &true, sizeof(true)},
  {CKA_LABEL, label, sizeof(label) - 1},
  {CKA_ALLOWED_MECHANISMS, mechanisms, sizeof(mechanisms)},
};
\end{verbatim}

Этот же шаблон может быть использован для поиска личного ключа.

\section{Механизмы}

\subsection{Механизм CKM\_EC\_KEY\_PAIR\_GEN}

%2.3.5

Для генерации ключей СТБ 34.101.45 должен использоваться стандартный 
механизм \verb|CKM_EC_KEY_PAIR_GEN|. Механизм не имеет параметров. 

Механизм поддерживается функцией~\verb|C_GenerateKeyPair|. 
%
Описатель механизма и шаблоны объектов открытого и личного
ключей подаются на вход~\verb|C_GenerateKeyPair|. Параметры ЭК задаются в 
атрибуте \verb|CKA_EC_PARAMS| шаблона открытого ключа.

\addendum{Механизм} однозначно определяет атрибуты
\verb|CKA_CLASS|, \verb|CKA_KEY_TYPE| и \verb|CKA_EC_POINT|
объекта открытого ключа и атрибуты
\verb|CKA_CLASS|, \verb|CKA_KEY_TYPE|, \verb|CKA_EC_PARAMS| и \verb|CKA_VALUE| объекта личного ключа.

\doubt{todo: нужно ли говорить, что шаблоны должны быть согласованы?
В чем заключается согласованность? О атрибутах
CKA\_CLASS, CKA\_KEY\_TYPE уже сказано в СТБ 34.101.21.}

\addendum{При генерации} ключей КТ, соответствующих СТБ 34.101.79,
уровень стойкости, неявно определяемый атрибутом \verb|CKA_ID| личного ключа,
должен соответствовать параметрам ЭК, указываемым в атрибуте \verb|CKA_EC_PARAMS| открытого ключа. \doubt{Значения атрибутов} \verb|CKA_SIGN| личного ключа и \verb|CKA_VERIFY| открытого ключа должны совпадать. \doubt{Значения атрибутов} \verb|CKA_UNWRAP| личного ключа и \verb|CKA_WRAP| открытого ключа должны совпадать.

\subsection{Механизм CKM\_BIGN}

Для выработки ЭЦП в соответствии с СТБ 34.101.45 по заданному хэш-значению 
сообщения должен использоваться механизм \verb|CKM_BIGN|. Механизм может 
дополнительно реализовывать проверку ЭЦП. 
%
Параметр механизма (\addendum{указывается в
структуре}~\verb|CK_MECHANISM|)~--- DER-код идентификатора используемого 
алгоритма хэширования.

Идентификатор механизма: \texttt{0x00008001} 
(\addendum{синтаксис языка Си, принятый в СТБ 34.101.21}). 

Механизм поддерживается функциями выработки и проверки ЭЦП: 
\verb|C_SignInit|, \verb|C_Sign|, \verb|C_VerifyInit|, \verb|C_Verify|.

При выработке подписи описатели сеанса, механизма и объекта
личного ключа подаются на вход функции \verb|C_SignInit|.
Описатель сеанса, указатели на подписываемое хэш-значение и выходное значение подписи
вместе с их размерами подаются на вход функции \verb|C_Sign|.

При проверке подписи описатели сеанса, механизма и объекта
открытого ключа подаются на вход функции \verb|C_VerifyInit|.
Описатель сеанса, указатели на подписанное хэш-значение и значение подписи
вместе с их размерами подаются на вход функции \verb|C_Verify|.

Длины входных и выходных данных (хэш-значение, подпись) функций
\verb|C_Sign| и \verb|C_Verify| должны соответствовать
уровню стойкости~$l$ соответствующего ключевого объекта.

\doubt{todo: есть свобода по выбору фх? я не против, но до сих пор свободы 
не было~--- фх однозначно определялась уровнем стойкости.
done: Перенес ниже, т.к. SignInit, VerifyInit не объявлены выше.. }

\addendum{Реализация} библиотеки может ограничивать множество
допустимых хэш-функций, в этом случае функции \verb|C_SignInit|,
\verb|C_VerifyInit| должны возвращать \verb|CKR_MECHANISM_PARAM_INVALID|.

\subsection{Механизм CKM\_BIGN\_HBELT}

Для выработки ЭЦП в соответствии с алгоритмами~\texttt{bign-with-hbelt} 
(см.~\ref{CRYPTO.Sign}) должен использоваться механизм \verb|CKM_BIGN_HBELT|. 
Механизм может дополнительно реализовывать проверку ЭЦП. 
%
Механизм не имеет параметров.

Идентификатор механизма: \texttt{0x00008002}.

Механизм поддерживается функциями выработки и проверки ЭЦП: 
\verb|C_SignInit|, \verb|C_SignUpdate|, \verb|C_SignFinal|, 
\verb|C_VerifyInit|, \verb|C_VerifyUpdate|, \verb|C_VerifyFinal|.

При выработке подписи описатели сеанса, механизма и объекта
личного ключа подаются на вход функции \verb|C_SignInit|.
Описатель сеанса, подписываемые данные целиком или по частям подаются
на вход функции \verb|C_SignUpdate|.
Описатель сеанса, указатель на выходное значение подписи вместе с размером
подаются на вход функции \verb|C_SignFinal|.

При проверке подписи описатели сеанса, механизма и объекта
открытого ключа подаются на вход функции \verb|C_VerifyInit|.
Описатель сеанса, подписанные данные целиком или по-частям подаются
на вход функции \verb|C_VerifyUpdate|.
Описатель сеанса, указатель на значение подписи вместе с размером
подаются на вход функции \verb|C_VerifyFinal|.

В механизме должны использоваться ключи уровня стойкости $l=128$ 
и стандартные параметры ЭК этого уровня (см.~\ref{CRYPTO.Params}).
% 
Буфер подписи, подаваемый на вход функций \verb|C_SignFinal| и 
\verb|C_VerifyFinal|, должен состоять из 48 октетов.

\subsection{Механизм CKM\_BIGN\_BASH}

Для выработки ЭЦП в соответствии с алгоритмами~\texttt{bign-with-bash384},
\texttt{bign-with-bash512} (см.~\ref{CRYPTO.Sign}) должен использоваться 
механизм \verb|CKM_BIGN_BASH|. Механизм может дополнительно реализовывать 
проверку ЭЦП.
\doubt{Если мы разрешаем в CKM\_BIGN произвольный OID хф,
то имеел смысл и здесь разрешить bign-with-bash256.}
%
Механизм не имеет параметров.

Идентификатор механизма: \texttt{0x00008003}.

Механизм~\verb|CKM_BIGN_BASH| поддерживается теми же функциями и по тем же 
правилам, что и механизм~\verb|CKM_BIGN_HBELT|.

В механизме должны использоваться ключи уровней стойкости $l=192$ и~$l=256$
и стандартные параметры ЭК этих уровней (см.~\ref{CRYPTO.Params}).
% 
Буфер подписи, подаваемый на вход функций \verb|C_SignFinal| и 
\verb|C_VerifyFinal|, должен состоять из 72 ($l=192$) или 96 ($l=256$) 
октетов. 

\subsection{Механизм CKM\_BIGN\_TSP}

%2.3.12

Для разбора токена ключа в соответствии с алгоритмами~\texttt{bign-keytransport}
(см.~\ref{CRYPTO.Transport}) должен использоваться механизм \verb|CKM_BIGN_TSP|. 
Механизм может дополнительно реализовывать создание токена ключа.
%
Параметр механизма~-- заголовок транспортируемого ключа (16~октетов). 
Параметр может опускаться, и тогда должен использоваться
\addendum{заголовок, состоящий из 16~нулевых октетов.} 

Идентификатор механизма: \texttt{0x00008004}.

Механизм подерживается функциями создания и разбора токена ключа:
\verb|C_WrapKey| и \verb|C_UnwrapKey|.

При создании токена на вход функции \verb|C_WrapKey| подаются
описатель сеанса, описатель механизма, описатели объектов открытого ключа
получателя и транспортируемого ключа, указатель на
выходное значение токена ключа вместе с размером.
Размер транспортируемого ключа должен быть не менее 16 октетов.
Объект транспортируемого ключа может иметь произвольный класс и тип.

При разборе токена на вход функции \verb|C_UnwrapKey| подаются
описатель сеанса, описатель механизма, описатель объекта личного ключа
получателя, указатель на значение токена ключа вместе с размером,
набор атрибутов для создания нового ключа и указатель,
который на выходе получает описатель на созданный ключ.
Размер токена ключа должен быть не менее 32 октетов.
Объект нового ключа может иметь произвольный класс и тип.

\section{Программная библиотека}

Производитель КТ должен предоставить программную библиотеку, реализующую
интерфейс Cryptoki. 

Дополнительно к описанным выше функциям криптографических механизмов 
\addendum{для минимальной работы могут использоваться} следующие функции:
\begin{itemize}
\item[--]
\verb|C_Initialize|~--- инициализация библиотеки;
\item[--] 
\verb|C_GetInfo|~--- получение информации о библиотеке;
\item[--] 
\verb|C_GetFunctionList|~--- получение указателей на реализации функций;
\item[--]
\verb|C_GetSlotList|~--- перечисление слотов в системе;
\item[--]
\verb|C_GetSlotInfo|~--- получение информации о слоте;
\item[--]
\verb|C_GetTokenInfo|~--- получение информации о КТ, находящемся в 
выбранном слоте;
\item[--]
\verb|C_GetMechanismList|~--- 
получение списка механизмов, поддерживаемых КТ;
\item[--]
\verb|C_OpenSession|~--- открытие сеанса работы с КТ;
\item[--]
\verb|C_Login|~--- парольная аутентификация пользователя перед КТ;
\item[--]
\verb|C_FindObjectsInit|, \verb|C_FindObjects|, 
\verb|C_FindObjectsFinal|~---
поиск объекта на основании шаблона;
\item[--]
\verb|C_GetAttributeValue|~--- \addendum{получение атрибутов объекта};
\item[--]
\verb|C_Logout|~--- завершение работы с критическими объектами КТ;
\item[--]
\verb|C_CloseSession|~--- завершение сеанса работы с КТ;
\item[--]
\verb|C_Finalize|~--- завершение работы с библиотекой.
\end{itemize}

Функции должны быть реализованы в соответствии с СТБ 34.101.21.
Схема работы с функциями также определена в СТБ 34.101.21.

Параметром функции \verb|C_Login| является пароль владельца КТ.
\addendum{
Пароль может содержать любые символы UTF-8, кроме \str{:} 
(графический код байта $58=\hex{3A}$). Пароль может сопровождаться 
служебной информацией: тип пароля, настройки состояния владельца,
разрешения владельца на доступ к объектам. 
%
Пример пароля вместе со служебной информацией: \str{1123581321:PUK}. 
}

\addendum{Экспорт открытого ключа} может быть выполнен
с помощью функции \verb|C_GetAttributeValue|, указав атрибут
\verb|CKA_EC_POINT| в шаблоне запрашиваемых атрибутов.
\doubt{todo: export (при необходимости или всегда?)} 

\doubt{todo: можно ли что-то сократить (сделать обязательным при 
выполнении условий)?
%
Нельзя говорить, что должен быть реализован какой-то
поднабор, т.к. должны быть реализованы все функции Cryptoki.
Можно говорить о наборе функций, которые могут использоваться
в какой-то КП в том или ином сценарии, но нельзя ограничивать
набор только этими функциями - это идет в разрез с Cryptoki.
Другая КП может использовать другие функции Cryptoki.
%
набросок ниже} 

\doubt{
Могут быть реализованы дополнительные функции. 
%
Рекомендуется дополнительно реализовать информационные функции:
GetFunctionList? GetInfo? GetSlotInfo?, GetTokenInfo? GetMechanismList?
%
При размещении на КТ нескольких ключей и необходимости поиска одного из 
них должны быть дополнительно реализованы функции FindObjectsInit, FindObjects, 
FindObjectsFinal~--- поиск объекта на основании шаблона;
}

\if0
Т.о. для работы требуется наличие КТ, а также знание его
серийного номера, пароля доступа к нему и идентификатор личного ключа.
Серийный номер используется вместе с функцией~\verb|C_GetTokenInfo|
для выбора нужного КТ при наличии нескольких.
Пароль доступа подается на вход~\verb|C_Login|.
При генерации и для выбора личного ключа
используется его идентификатор, который указывается
в качестве атрибута~\verb|CKA_ID| шаблона объкта.
Шаблон затем подается на вход~\verb|C_GenerateKeyPair|
для генерации либо на вход~\verb|C_FindObjectsInit| для
поиска.
\fi

\if 0
\section{Сценарий работы}

В этом разделе рассматривается типовой сценарий работы,
включающий следующие шаги: выбор токена стороннего
производителя, аутентификация с помощью PIN-кода, выбор
личного ключа и выработка подписи, завершение работы.
Для каждого шага описываются основные действия и
уточняются, где это необходимо, аргументы функций Cryptoki,
используемых при этом.
Сами функции, принимаемые аргументы и примеры
их использования определены в СТБ 34.101.21.

Производитель токенов должен предоставить библиотеку,
реализующую интерфейс Cryptoki. Перед началом работы прикладная
программа, желающая работать с токенами конкретного
производителя, должна загрузить соответствующую библиотеку
Cryptoki. Библиотека OpenSC реализует Cryptoki и позволяет
взаимодействовать со смарт-картами многих производителей.

\subsection{Начало работы и выбор токена}

% функции общего назначения
В начале работы библиотека Cryptoki должна быть
проинициализирована с помощью функции \verb|C_Initialize|.

Получить информацию о библиотеке, в т.е. версию интерфейса
Cryptoki, идентификатор производителя, описание и версию
библиотеки, можно с помощью функции \verb|C_GetInfo|.
\doubt{Эта функция может быть использована для подтверждения
возможности работы согласно Cryptoki необходимой версии,
а также с токенами конкретного производителя.}

Затем требуется получить список указателей на функции Cryptoki
с помощью \verb|C_GetFunctionList|.

% функции управления слотами и токенами
Следующим этапом требуется выбрать слот -- логическое
устройство чтения токенов (например, считыватель смарт-карт),
а затем токен.
Функция \verb|C_GetSlotList| возвращает список слотов в системе.

Для получения информации о слоте, включая описание слота,
идентификатор производителя, версии прошивки и аппаратной
части слота, используется функция \verb|C_GetSlotInfo|.
\doubt{Эта функция может быть использована для потверждения
выбора требуемого слота.}

Для получения информации о токене, находящемся в выбранном
слоте, используется функция \verb|C_GetTokenInfo|.
Функция возвращает метку токена, идентификатор производителя,
модель и серийный номер токена, версии прошивки и
аппаратной части токена.
\doubt{Эта функция может быть использована для потверждения
выбора требуемого токена.}

Для получения списка механизмов, поддерживаемых токеном,
используется функция \verb|C_GetMechanismList|.
\doubt{Эта функция может быть использована для потверждения
поддержки токеном механизмов, определенных в настоящем
стандарте.}

%TODO: Этот подраздел можно сократить до:
%Библиотека должна поддерживать Cryptoki версии не ниже 2.20.
%Токен должен поддерживать механизмы, описанные в данном стандарте.

\subsection{Аутентификация}

% функции управления сессиями
После поиска и выбора токена требуется открыть сеанс
взаимодействия между прикладной программой и токеном с
помощью функции \verb|C_OpenSession|.

Для аутентификации пользователя перед токеном в рамках
выбранной сессии требуется вызвать функцию \verb|C_Login|.

Успешное выполнение функции \verb|C_Login| разрешает
выполнение команд с критическими объектами (ключами).

\doubt{Токены согласно СТБ 34.101.btok при аутентификации
принимают дополнительный параметр, определяющий количество
выработок подписей без дополнительного подтверждения PIN-кода.}
Функции \verb|C_OpenSession| и \verb|C_Login| не принимают
дополнительные параметры, которые можно использовать для
изменения их поведения.

%TODO:
%Количество выработок подписей можно передавать как первый или
%последний байт PIN-кода, но прикладная программа и библиотека
%должны поддерживать такое поведение, не соответствующее
%интерфейсу Cryptoki.

\subsection{Выбор личного ключа}

% функции управления объектами
Выработать пару ключей можно с помощью функции
\verb|C_GenerateKeyPair|, на вход которой подаются атрибуты
объектов открытого и личного ключей.

Выбор существующих ключей выполняется с помощью функций
поиска объектов. Функция \verb|C_FindObjectsInit| инициализации
поиска объекта позволяет задать критерии поиска на основании
шаблона, в котором указываются атрибуты искомого объекта.
Функция \verb|C_FindObjects| возвращает описатели объектов,
удовлетворяющих шаблону. Функция \verb|C_FindObjectsFinal|
завершает поиск.

При создании шаблона объекта личного ключа для однозначной
идентификации объекта следует указывать атрибут \verb|CKA_ID|.

Функции генерации и поиска возвращают описатели ключевых
объектов, которые могут быть использованы при выработке подписи
и транспорте ключа.

%TODO: Этот подраздел можно сократить до:
%При генерации и выборе личных ключей нужно указывать
%атрибут \verb|CKA_ID|.

%\subsection{Выработка подписи}
%\subsection{Создание запроса на выпуск сертификата}
%\subsection{Транспорт ключа}

\subsection{Завершение работы}

Для завершения работы с критическими объектами токена
используется функция \verb|C_Logout|.

Для завершения сеанса работы с токеном используется функция
\verb|C_CloseSession|.

Для завершения работы и деинициализации библиотеки
используется функция \verb|C_Finalize|.
\fi
