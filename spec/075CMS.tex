\section{Подписанные данные}\label{FMT.SignedData}

Формат подписанных данных задается типом \texttt{SignedData}, 
который определен в СТБ 34.101.23. Тип описывает версию применяемого 
синтаксиса, список алгоритмов хэширования, подписываемые данные, 
сертификат подписывающей стороны и информацию о подписывающей стороне. 

Версия синтаксиса указывается в компоненте \texttt{version}.
Должна использоваться версия~$1$.

Список алгоритмов хэширования указывается в компоненте
\texttt{digestAlgorithms}. Список должен содержать единственный алгоритм,
и этот алгоритм должен быть выбран из перечня, 
заданного в~\ref{CRYPTO.Hash}.

Подписываемые данные указываются в компоненте~\texttt{encapContentInfo}. 
%
В зависимости от типа данных, вложенный в~\texttt{encapContentInfo} 
компонент~\texttt{eContentType} должен принимать одно из следующих значений:
\begin{enumerate}
\item[1)]
\texttt{id-ct-TSTInfo}, если подписывается ответ СШВ (см.~\ref{FMT.TSP.Resp});
\item[2)]
\texttt{id-ct-DVCSResponseData}, если подписывается ответ СЗД 
(см.~\ref{FMT.DVCS.Resp});
\item[3)]
\texttt{bpki-ct-enroll1-req}, если в сценарии~\texttt{Enroll1} 
процесса~\texttt{Enroll} подписывается запрос на выпуск сертификата 
(см.~\ref{PROCESSES.Enroll.Signed}); 
\item[4)]
\texttt{bpki-ct-enroll2-req}, если в сценарии~\texttt{Enroll2} 
процесса~\texttt{Enroll} подписывается запрос на выпуск сертификата 
(см.~\ref{PROCESSES.Enroll.Signed}); 
\item[5)]
\texttt{bpki-ct-reenroll-req}, если в процессе~\texttt{Reenroll} 
подписывается запрос на выпуск сертификата 
(см.~\ref{PROCESSES.Reenroll}); 
\item[6)]
\texttt{bpki-ct-spawn-req}, если в процессе~\texttt{Spawn} 
подписывается запрос на выпуск сертификата 
(см.~\ref{PROCESSES.Spawn}); 
\item[7)]
\texttt{bpki-ct-setpwd-req}, если в процессе~\texttt{Setpwd} 
подписывается новый пароль (см.~\ref{PROCESSES.Setpwd}); 
\item[8)]
\texttt{bpki-ct-revoke-req}, если в процессе~\texttt{Revoke} 
подписывается запрос на отзыв сертификата (см.~\ref{PROCESSES.Revoke}); 
\item[9)]
\texttt{bpki-ct-resp}, если подписывается ответ УЦ 
(см.~\ref{FMT.BPKIResp}).
\end{enumerate}

Первый идентификатор определен в СТБ 34.101.81, второй~--- в СТБ 
34.101.82, остальные~--- в приложении~\ref{ASN1}.

Необязательный компонент~\texttt{certificates}
должен включаться в контейнер~\texttt{SignedData} и должен 
содержать единственный сертификат~--- сертификат подписанта.
%
Необязательный компонент~\texttt{crls} должен быть опушен.

Информация о подписывающей стороне указывается в 
компоненте~\texttt{signerInfos}. Компонент должен содержать единственный 
контейнер типа~\texttt{SignerInfo}, который должен быть заполнен следующим 
образом: 
\begin{enumerate}
\item 
Версия (компонент \texttt{version}) должна равняться~$1$.
\item 
Идентификатор подписанта (\texttt{sid}) должен быть задан через
тип~\texttt{IssuerAndSerialNumber}. Компоненты~\texttt{issuer} 
и~\texttt{serialNumber} этого типа должны повторять одноименные компоненты 
сертификата подписанта.
\item 
Идентификатор алгоритма хэширования (\texttt{digestAlgorithm}) должен 
совпадать с идентификатором, указанным в 
компоненте~\texttt{digestAlgorithms} основного 
контейнера~\texttt{SignedData}. 
\item 
Идентификатор алгоритмов ЭЦП (\texttt{signatureAlgorithm}) должен 
быть выбран из перечня, заданного в~\ref{CRYPTO.Sign}. 
Алгоритмы ЭЦП должны быть совместимы с алгоритмом хэширования 
из~\texttt{digestAlgorithm}.
\item 
В список подписанных атрибутов (\texttt{signedAttrs}) должны 
быть включены атрибуты <<Тип содержимого>> (\texttt{contentType}),
<<Хэш-значение>> (\texttt{MessageDigest}) и может быть включен
атрибут <<Время подписания>> (\texttt{SigningTime}). 
Все атрибуты определены в СТБ 34.101.23. 
\item 
Список неподписанных атрибутов (\texttt{unsignedAttrs}) должен быть пуст.
\end{enumerate}

Алгоритм ЭЦП должен быть выбран из перечня, заданного в~\ref{CRYPTO.Sign}. 
Вспомогательный для алгоритма ЭЦП алгоритм хэширования должен
совпадать с алгоритмом, указанным в компоненте~\texttt{digestAlgorithms}. 

\section{Конвертованные данные}\label{FMT.EnvelopedData}

Формат конвертованных данных задается типом~\texttt{EnvelopedData}, который
определен в СТБ 34.101.23. Тип описывает версию применяемого синтаксиса,
конвертованные данные и информацию об их получателе.

Версия применяемого синтаксиса указывается в компоненте
\texttt{version}. Должна использоваться версия~$2$.

Конвертованные данные указываются в компоненте~\texttt{encryptedContentInfo}.
%
Вложенный в~\texttt{encryptedContentInfo} компонент~\texttt{contentEncryptionAlgorithm}
описывает алгоритм шифрования конвертованных данных. Используемый алгоритм 
должен быть выбран из перечня, заданного в~\ref{CRYPTO.Encr}.

В зависимости от типа конвертуемых данных, вложенный 
в~\texttt{encryptedContentInfo} компонент~\texttt{eContentType} 
должен принимать одно из следующих значений:
\begin{enumerate}
\item[1)]
\texttt{id-signedData}, если конвертуются подписанные данные;
\item[2)]
\texttt{id-data}, если конвертуются неструктурированные данные:
запрос на получение сертификата, сертификат, запрос на отзыв сертификата.
\end{enumerate}

% todo: сказать про атрибуты -- отсутствуют

% todo: сказать, что originatorInfo отсутствует

Информация о получателе указывается в компоненте~\texttt{recipientInfos}.
Компонент должен содержать единственный элемент 
типа~\texttt{RecipientInfo}, и в этом элементе должен быть выбран  
компонент~\texttt{ktri} типа~\texttt{KeyTransRecipientInfo}.  
Компонент~\texttt{ktri} описывает версию применяемого синтаксиса, 
идентификатор получателя, алгоритм транспорта ключа и токен ключа. 
Версия должна быть равна 2. Идентификатор получателя должен 
иметь тип~\texttt{subjectKeyIdentifier}. Должен использоваться алгоритм 
транспорта ключа~\texttt{bign-keytransport}, описанный 
в~\ref{CRYPTO.Transport}. 

% todo: идентификация получателя skid vs issuer_and_serial. 
% Почему выбран skid?
