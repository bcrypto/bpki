\chapter{Программный интерфейс}\label{CRYPTOKI}

%\newcommand{\bign}{Bign}
%\newcommand{\hbelt}{HBelt}
%\newcommand{\bash}{Bash}

\section{Общие положения}

PKCS\#11, принятый как СТБ 34.101.21, определяет программный
интерфейс взаимодействия с КТ, называемый Cryptoki.
Интерфейс содержит фиксированный набор функций, позволяющий
выполнять широкий набор криптографических команд, и
оперирует такими понятиями, как механизм и ключевой объект.

В настоящем разделе уточняется использование введенных
в СТБ 34.101.21 объектов и вводятся новые механизмы для поддержки
алгоритмов СТБ 34.101.45 (генерация ключей, подпись и транспорт ключа).

\section{Объекты}

\subsection{Использование атрибутов}

Объектам Cryptoki назначаются атрибуты. Атрибуты
определяют такие параметры объектов, как класс, тип, описание и др. 
Атрибуты указываются в шаблоне объекта.
В зависимости от контекста атрибуты подчиняются тем или иным правилам.
Некоторые правила собраны в таблице~\ref{Table.CRYPTOKI.AttrUse}.
Далее при описании атрибута будут указываться номера правил из таблицы. 

\begin{table}[H]
\caption{Правила использования атрибутов}\label{Table.CRYPTOKI.AttrUse}
\begin{tabular}{|c|p{420pt}|}
\hline
\# & правило\\
\hline
\hline
1 & ДОЛЖЕН быть указан при создании объекта с помощью
\verb|C_CreateObject|.\\
\hline
\doubt{2} & НЕ ДОЛЖЕН быть указан при создании объекта с помощью
\verb|C_CreateObject|.\\
\hline
3 & ДОЛЖЕН быть указан при генерации объекта с помощью
\verb|C_GenerateKey| или \verb|C_GenerateKeyPair|.\\
\hline
4 & НЕ ДОЛЖЕН быть указан при генерации объекта с помощью
\verb|C_GenerateKey| или \verb|C_GenerateKeyPair|.\\
\hline
5 & ДОЛЖЕН быть указан при извлечении объекта с помощью
\verb|C_UnwrapKey|.\\
\hline
6 & НЕ ДОЛЖЕН быть указан при извлечении объекта с помощью
\verb|C_UnwrapKey|.\\
\hline
7 & НЕ МОЖЕТ быть раскрыт, если объект имеет атрибут
\verb|CKA_SENSITIVE| со значением \verb|CK_TRUE| или атрибут
\verb|CKA_EXTRACTABLE| со значением \verb|CK_FALSE|.\\
\hline
\end{tabular}
\end{table}

\subsection{Параметры эллиптической кривой}
%2.3
Если в криптографическом механизме используются параметры ЭК, 
объявленные в подразделе~\ref{CRYPTO.Params}, 
то в структуре \verb|CK_MECHANISM_INFO| описания механизма 
должны быть указаны следующие информативные флаги:
\verb|CKF_EC_F_P|~-- механизм может использоваться с
параметрами ЭК, заданной над простым полем,
\verb|CKF_EC_NAMEDCURVE|~-- параметры ЭК задаются идентификатором,
\verb|CKF_EC_UNCOMPRESS|~-- точки ЭК задаются в несжатом виде.

Параметры ЭК (см. подраздел~\ref{CRYPTO.Params}), закодированные
по различительным правилам, указываются как значение
атрибута \verb|CKA_EC_PARAMS|.

Параметры ЭК однозначно определяют длины значений
личного и открытого ключей, подписываемого хэш-значения и
подписи: $l/4$, $l/2$, $l/4$ и $3l/8$ октетов соответственно,
где~$l$~-- уровень стойкости ЭК. 

\subsection{Объект открытого ключа}
%2.3.3
Объект, хранящий открытый ключ СТБ 34.101.45, должен иметь
класс \verb|CKO_PUBLIC_KEY| и тип ключа \verb|CKK_EC|.
В таблице~\ref{Table.CRYPTOKI.EcPubkeyAttrs} указаны
атрибуты объекта открытого ключа в дополнение к обычным
атрибутам, указываемым для этого класса.

\begin{table}[H]
\caption{Атрибуты объекта открытого ключа}\label{Table.CRYPTOKI.EcPubkeyAttrs}
\begin{tabular}{|c|c|c|c|}
\hline
атрибут & правила & тип & значение\\
\hline
\hline
\verb|CKA_EC_PARAMS| & 1,3 & Byte array &
параметры ЭК\\
\hline
\verb|CKA_EC_POINT| & 1,4 & Byte array &
значение открытого ключа, $l/2$ октетов\\
\hline
\end{tabular}
\end{table}

Ниже приведен пример шаблона для создания объекта открытого ключа СТБ 34.101.45:
\begin{verbatim}
CK_OBJECT_CLASS class = CKO_PUBLIC_KEY;
CK_KEY_TYPE keyType = CKK_EC;
CK_UTF8CHAR label[] = “BIGN public key object”;
CK_BYTE bignParams[] = {...};
CK_BYTE bignPubKey[] = {...};
CK_BBOOL true = CK_TRUE;
CK_ATTRIBUTE template[] = {
  {CKA_CLASS, &class, sizeof(class)},
  {CKA_KEY_TYPE, &keyType, sizeof(keyType)},
  {CKA_TOKEN, &true, sizeof(true)},
  {CKA_LABEL, label, sizeof(label)-1},
  {CKA_EC_PARAMS, bignParams, sizeof(bignParams)},
  {CKA_EC_POINT, bignPubKey, sizeof(bignPubKey)}
};
\end{verbatim}

\subsection{Объект личного ключа}
%2.3.4
Объект, хранящий личный ключ СТБ 34.101.45, должен иметь
класс \verb|CKO_PRIVATE_KEY| и тип ключа \verb|CKK_EC|.
В таблице~\ref{Table.CRYPTOKI.EcPrivkeyAttrs} указаны
атрибуты объекта личного ключа в дополнение к обычным
атрибутам, указываемым для этого класса.

\begin{table}[H]
\caption{Атрибуты объекта личного ключа}\label{Table.CRYPTOKI.EcPrivkeyAttrs}
\begin{tabular}{|c|c|c|c|}
\hline
атрибут & правила & тип & значение\\
\hline
\hline
\verb|CKA_EC_PARAMS| & 1,4,6 & Byte array &
параметры ЭК\\
\hline
\verb|CKA_VALUE| & 1,4,6,7 & Big integer &
личный ключ, $l/4$ октетов\\
\hline
\end{tabular}
\end{table}

Личные ключи генерируются только как часть пары ключей,
при этом параметры ЭК указываются только в шаблоне
открытого ключа.

Ниже приведен пример шаблона для создания объекта личного ключа СТБ 34.101.45:
\begin{verbatim}
CK_OBJECT_CLASS class = CKO_PRIVATE_KEY;
CK_KEY_TYPE keyType = CKK_EC;
CK_UTF8CHAR label[] = “BIGN private key object”;
CK_BYTE subject[] = {...};
CK_BYTE id[] = {123};
CK_BYTE bignParams[] = {...};
CK_BYTE bignPrivKey[] = {...};
CK_BBOOL true = CK_TRUE;
CK_ATTRIBUTE template[] = {
  {CKA_CLASS, &class, sizeof(class)},
  {CKA_KEY_TYPE, &keyType, sizeof(keyType)},
  {CKA_TOKEN, &true, sizeof(true)},
  {CKA_LABEL, label, sizeof(label)-1},
  {CKA_SUBJECT, subject, sizeof(subject)},
  {CKA_ID, id, sizeof(id)},
  {CKA_SENSITIVE, &true, sizeof(true)},
  {CKA_DERIVE, &true, sizeof(true)},
  {CKA_EC_PARAMS, bignParams, sizeof(bignParams)},
  {CKA_VALUE, bignPrivKey, sizeof(bignPrivKey)}
};
\end{verbatim}

\section{Механизмы}

\subsection{Механизм CKM\_EC\_KEY\_PAIR\_GEN}
%2.3.5
Механизм \verb|CKM_EC_KEY_PAIR_GEN| (СТБ 34.101.21, п.~12.3.5)
используется для генерации ключей СТБ 34.101.45.
Механизм не содержит параметров.
Механизм используется вместе с функцией генерации ключевой
пары (СТБ 34.101.21, п.~11.14).

Описатель механизма и шаблоны объектов открытого и личного
ключей подаются на вход функции \verb|C_GenerateKeyPair|.
Параметры ЭК задаются в атрибуте \verb|CKA_EC_PARAMS|
шаблона открытого ключа.

\subsection{Механизм CKM\_BIGN}

Механизм
\verb|CKM_BIGN| представляет механизм выработки и проверки
подписи СТБ 34.101.45 без вычисления хэш-значения.
Механизм имеет параметр~-- закодированный по различительным
правилам объектный идентификатор алгоритма хеширования. 
%см. тип CK_MECHANISM и поля pParameter и ulParameterLen
Идентификатор алгоритма хэширования определяет длину
хэш-значения сообщения.
Механизм используется вместе с функциями выработки и
проверки подписи (СТБ 34.101.21, п.~11.11, п.~11.12).

При выработке подписи описатели механизма и объекта
личного ключа подаются на вход функции \verb|C_SignInit|.
Указатели на подписываемое хэш-значение и выходное значение подписи
вместе с их размерами подаются на вход функции \verb|C_Sign|.
При проверке подписи описатели механизма и объекта
открытого ключа подаются на вход функции \verb|C_VerifyInit|.
Указатели на подписанное хэш-значение и значение подписи
вместе с их размерами подаются на вход функции \verb|C_Verify|.

Длины входных и выходных параметров (хэш-значение, подпись) функций
\verb|C_Sign| и \verb|C_Verify| ДОЛЖНЫ соответствовать
уровню стойкости ЭК соответствующего ключевого объекта.

\subsection{Механизм CKM\_BIGN\_HBELT}

Механизм
\verb|CKM_BIGN_HBELT| представляет алгоритмы выработки и проверки
подписи \texttt{bign-with-hbelt}, описанные в подразделе~\ref{CRYPTO.Sign}.
Механизм не содержит параметров. Механизм используется вместе с функциями 
выработки и проверки подписи (СТБ 34.101.21, п.~11.11, п.~11.12).

При выработке подписи описатели механизма и объекта
личного ключа подаются на вход функции \verb|C_SignInit|.
Подписываемые данные целиком или по-частям подаются
на вход функции \verb|C_SignUpdate|.
Указатель на выходное значение подписи вместе с размером
подается на вход функции \verb|C_SignFinal|.
При проверке подписи описатели механизма и объекта
открытого ключа подаются на вход функции \verb|C_VerifyInit|.
Подписанные данные целиком или по-частям подаются
на вход функции \verb|C_VerifyUpdate|.
Указатель на значение подписи вместе с размером
подается на вход функции \verb|C_VerifyFinal|.

Механизм должен быть использован только вместе с ключами
уровня стойкости $128$, сгенерированными с использованием 
ЭК с идентификатором \verb|bign-curve256v1|.
Длина значения подписи, подаваемого на вход функций
\verb|C_SignFinal| и \verb|C_VerifyFinal|, должна быть равна
48 октетам.

\subsection{Механизм CKM\_BIGN\_BASH}

Механизм
\verb|CKM_BIGN_BASH| представляет алгоритмы выработки и проверки
подписи \texttt{bign-with-bash384}, \texttt{bign-with-bash512},
описанные в подразделе~\ref{CRYPTO.Sign}.
Механизм не содержит параметров.
Механизм используется вместе с функциями выработки и
проверки подписи (СТБ 34.101.21, п.11.11, п.11.12).

При выработке подписи описатели механизма и объекта
личного ключа подаются на вход функции \verb|C_SignInit|.
Подписываемые данные целиком или по-частям подаются
на вход функции \verb|C_SignUpdate|.
Указатель на выходное значение подписи вместе с размером
подается на вход функции \verb|C_SignFinal|.
При проверке подписи описатели механизма и объекта
открытого ключа подаются на вход функции \verb|C_VerifyInit|.
Подписанные данные целиком или по-частям подаются
на вход функции \verb|C_VerifyUpdate|.
Указатель на значение подписи вместе с размером
подается на вход функции \verb|C_VerifyFinal|.

Механизм должен быть использован вместе с ключами 
уровней стойкости $l=192$ и $l=256$.
Длина значения подписи, подаваемого на вход функций
\verb|C_SignFinal| и \verb|C_VerifyFinal|, должна соответствовать
уровню стойкости ЭК соответствующего ключевого объекта.

\subsection{Механизм CKM\_BIGN\_TSP} %CKM\_ECDH\_BELT\_KWP
%2.3.12
Механизм
\verb|CKM_BIGN_TSP| представляет алгоритмы транспорта 
ключа~\texttt{bign-keytransport}, описанные в 
подразделе~\ref{CRYPTO.Transport}.
Механизм содержит параметр~--
заголовок транспортируемого ключа. Длина заголовка~--- 16 октетов.
Механизм используется вместе с функциями создания и
разбора токена ключа (СТБ 34.101.21, п.~11.14).

При создании токена на вход функции \verb|C_WrapKey| подаются
описатель механизма, описатели объектов открытого ключа
получателя и транспортируемого ключа, указатель на
выходное значение токена ключа вместе с размером.
Размер транспортируемого ключа должен быть не менее 16 октетов.
Объект транспортируемого ключа может иметь произвольный класс и тип. 

При разборе токена на вход функции \verb|C_UnwrapKey| подаются
описатель механизма, описатель объекта личного ключа
получателя, указатель на значение токена ключа вместе с размером,
набор атрибутов для создания нового ключа.
Размер токена ключа должен быть не менее 32 октетов.
Объект нового ключа может иметь произвольный класс и тип.

\subsection{Идентификаторы механизмов}

Описанным механизмам назначаются следующие идентификаторы:
\begin{verbatim}
#define CKM_BIGN         0x00008001
#define CKM_BIGN_HBELT   0x00008002
#define CKM_BIGN_BASH    0x00008003
#define CKM_BIGN_TSP     0x00008004
\end{verbatim}


