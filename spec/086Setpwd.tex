\section{Процесс \texttt{Setpwd}}\label{PROCESSES.Setpwd}

Процесс~\texttt{Setpwd} выполняют субъект сертификата и УЦ.
С помощью~\texttt{Setpwd} субъект меняет пароль отзыва своего 
сертификата. С помощью пароля можно отозвать сертификат даже при потере 
соответствующего личного ключа.

\doubt{
При выпуске сертификатов следует предусмотреть информирование субъекта 
о возможности смены пароля в будущем с помощью процесса~\texttt{Setpwd}.
}

\doubt{УЦ может предусмотреть контроль качества пароля.}

\doubt{УЦ может связывать пароль с отдельным сертификатом субъекта или со 
всеми его сертификатами, выпущенными данным УЦ.} 

Процесс~\texttt{Setpwd} состоит из следующих процедур:
\begin{itemize}
\item[--]
подготовка запроса;
\item[--]
отправка запроса УЦ;
\item[--]
обработка запроса;
\item[--]
возврат ответа;
\item[--]
обработка ответа.
\end{itemize}

Субъект выбирает пароль, представляет его значением типа~\texttt{UTF8String}
и подписывает это значение на своем личном ключе.
Подписанный запрос оформляется как контейнер \texttt{SignedData}.
%
\doubt{Субъекту следует выбирать выскоэнтропийные пароли достаточно большой 
длины.}
\doubt{Паролю должен предшествовать префикc \str{/RPWD:}.}


Субъект конвертует подписанный пароль на открытом ключе УЦ
и отправляет его УЦ в виде контейнера~\texttt{EnvelopedData}.
Перед отправкой субъект вычисляет идентификатор конвертованного запроса,
хэшируя его с помощью~\texttt{belt-hash}.

УЦ снимает защиту с контейнера~\texttt{EnvelopedData} и определяет 
вложенный контейнер~\texttt{SignedData}. УЦ находит в контейнере
сертификат отправителя и проверяет, что сертификат действительно 
выдан самим УЦ. После этого УЦ проверяет тип содержимого и подпись 
контейнера~\texttt{SignedData}. \doubt{Тип содержимого должен равняться
\texttt{bpki-ct-setpwd-req}.} Если проверки прошли успешно, то УЦ  
связывает с сертификатом отправителя присланный пароль. УЦ может отказать 
в связывании, если пароль не удовлетворяет определенным метрикам качества.

УЦ возвращает статус обработки запроса в контейнере~\texttt{BPKIResp}.
Разрешены статусы~\texttt{granted} и~\texttt{rejection}.
В компоненте~\texttt{requestId} контейнера указывается идентификатор 
запроса, вычисленный УЦ с помощью~\texttt{belt-hash}.

Ответ~\texttt{BPKIResp} подписывается агентом УЦ. 
Подписанный ответ оформляется как контейнер~\texttt{SignedData}. Контейнер 
отправляется субъекту.

Субъект проверяет \doubt{тип содержимого} и подпись ответа. Если подпись 
действительна, то субъект проверяет совпадение указанного в ответе 
идентификатора~\texttt{requestId} с сохраненным идентификатором запроса. 
При успешной проверке субъект разбирает статус ответа и либо переходит 
на новый пароль при статусе~\texttt{granted}, либо оставляет действующий
при статусе~\texttt{rejection}. 

При ошибках проверки субъект не может быть уверен, что УЦ обработал
его запрос и перешел на новый пароль. Поэтому субъект должен хранить  
некоторое время два пароля. Окончательное решение о смене пароля 
субъект должен принять, повторно выполнив~\texttt{Setpwd}.
